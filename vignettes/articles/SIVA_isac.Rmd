---
title: "SIVAisac"
output:
  html_document:
    keep_md: yes
    code_folding: hide
    number_sections: yes
    toc: yes
    toc_depth: 3
    toc_float: yes
params: 
  debut: !r Sys.Date()-365*3
  fin: !r Sys.Date()
  work_with_db: TRUE
---


Ce document prends comme paramètre la date du jour et la date du jour - 30 C'est
une version de démo des fonctionnalités du package, et une exploration du code
possible avant de faire le shiny



```{r init, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
list=ls(all=TRUE)
library(safer)
library(getPass)
if (!exists("mainpass")) mainpass <- getPass(msg="Main password")
list<-list[-match(c("passworddistant","passwordlocal","umysql","pwdmysql"),list)  ]
rm(list) # nettoyage complet
debut<-as.character(params$debut)
fin<-as.character(params$fin)
load_library=function(necessary) {
  if(!all(necessary %in% installed.packages()[, 'Package']))
    install.packages(necessary[!necessary %in% installed.packages()[, 'Package']], dep = T)
  for(i in 1:length(necessary))
    library(necessary[i], character.only = TRUE)
}
load_library('stringr') # text handling
load_library('lubridate')
load_library('reshape2')
load_library('tidyverse')	
devtools::load_all(".")

#'==========================================================
#' Définition du nom des couleurs
#'==========================================================

bleu_EV <- "#00218f"
turquoise_EV <- "#00C9C4"
orange_EV <- "#ff7557"
jaune_EV <- "#ffb428"
bleu_EVf <- "#001350"
jaune_EVf <- "#AD7000"
orange_EVf <- "#b2513c"
bleu_clair_EV <- "#33b5ff"
turquoise_EVf <- "#007873"

library(SIVA)


```

# chargement des données

Les données seront chargées de `r debut` à `r fin`
Dans le programme de chargement `tags = isac$tag[isac$isac]` va chercher les données isac
où `isac$isac` correspond à `r isac$isac`.
C'est une réindexation. Pour aller chercher d'autres valeurs on peut changer les valeurs,
par rapport au tableau ci-dessous.

```{r dataisac, echo = FALSE}
knitr::kable(SIVA::isac)
```
Il faut aussi demander à Cédric les valeurs à mettre pour la connexion et les
passer à la main comme ci-dessous


```{r dataisac, echo = TRUE, eval = FALSE }
  pool <- pool::dbPool(
    drv = RMariaDB::MariaDB(),
    dbname = "archive_IAV",
    host = "demande à Cédric",
    username = "demande à Cédric le nom en lecture",
    password = "demande à Cédric le mot de passe hyper - secret",
    port=3306
  )
```





```{r loadisac}

if (params$work_with_db){
  if (!exists("mainpass")) mainpass <- getPass::getPass(msg = "main password")
  if (!exists("hostmysql")) {
    hostmysql. <- getPass::getPass(msg = "Saisir host")
    # ci dessous pour ne pas redemander au prochain tour
    hostmysql <- encrypt_string(string = hostmysql., key = mainpass)
  } else {
    hostmysql. <- decrypt_string(string = hostmysql, key = mainpass)
  }
  if (!exists("pwdmysql")) {
    pwdmysql. <- getPass::getPass(msg = "Saisir password")
    pwdmysql <- encrypt_string(string = pwdmysql., key = mainpass)
  }  else {
    # pass should be loaded
    pwdmysql. <- decrypt_string(string = pwdmysql, key = mainpass)
  }
  if (!exists("umysql")) {
    umysql. <- getPass::getPass(msg = "Saisir user")
    umysql <- encrypt_string(string = umysql., key = mainpass)
  } else {
    umysql. <- decrypt_string(string = umysql, key = mainpass)
  }
  # attention il faut avaoir définit mainpass <- "xxxxx"
  
  pool <- pool::dbPool(
    drv = RMariaDB::MariaDB(),
    dbname = "archive_IAV",
    host = hostmysql.,
    username = umysql.,
    password = pwdmysql.,
    port=3306
  )
  
  
  system.time(isac_dat <-
          load_isac(
              debut = as.POSIXct(
                  strptime(debut, format = "%Y-%m-%d")
                ),
                fin = as.POSIXct(
                  strptime(fin, format = "%Y-%m-%d")
                ),
              tags = isac$tag[isac$isac],
              con = pool
          ))
} # end if params$work_with_db



pool::poolClose(pool)
save(isac_dat, file=str_c("C:/temp/isac.Rdata"))

```

# Traitement des données

Ci dessous calcul du fonctionnement de la passe


```{r calcul_isac}
# chargement des paramètres du barrage
if (!params$work_with_db){
  load(file=str_c("C:/temp/isac.Rdata")) # nommé isac_dat
}
# petite analyse des données pour tenter de comprendre ...
plot(isac_dat$horodate, isac_dat$pontdecran)
plot(isac_dat$horodate, isac_dat$guenrouet)
plot(isac_dat$horodate,isac_dat$vilaine_barrage)
plot(isac_dat$horodate, isac_dat$isac_amont2)

plot(isac_dat$horodate,isac_dat$isac_fonctionnement_cumul_p1)
plot(isac_dat$horodate,isac_dat$isac_fonctionnement_cumul_p3)
plot(isac_dat$horodate,isac_dat$isac_position_vanne_1)
plot(isac_dat$horodate,isac_dat$isac_position_vanne_2)
```



